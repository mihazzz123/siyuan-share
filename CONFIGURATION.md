# Инструкция по настройке плагина

## Обзор

Плагин настроен для взаимодействия с бэкенд-сервером через API. Ниже приведены шаги по настройке и описание параметров.

## Настройки

Плагину требуются три важных параметра:

### 1. Адрес сервера (Server URL)
- **Назначение**: Адрес бэкенд-сервиса публикации.
- **Пример**: `https://share.your-domain.com`
- **Описание**: Используется для создания публикаций и управления ими через API.

### 2. API Token
- **Назначение**: Токен авторизации для вашего бэкенд-сервиса.
- **Описание**: Используется для подтверждения прав при обращении к API публикации.
- **Как получить**: 
  1. Запустите бэкенд-сервис.
  2. Выполните `backend/api/tools/create_user.go` для создания пользователя.
  3. Используйте сгенерированный API Token.

### 3. Токен ядра SiYuan (SiYuan Kernel Token)
- **Назначение**: Токен авторизации для внутреннего API самого приложения SiYuan.
- **Описание**: 
  - Используется для экспорта содержимого документов и других внутренних операций.
  - Все HTTP API SiYuan требуют этот токен.
  - Это официальный и безопасный способ доступа к данным.
- **Зачем это нужно**: 
  1. Плагину нужно вызывать `/api/export/exportMdContent` для получения текста заметки.
  2. Гарантирует, что только авторизованные программы имеют доступ к вашим данным.
- **Как получить**: 
  1. Откройте SiYuan.
  2. Перейдите в `Настройки` -> `О программе` -> `API Token`.
  3. Скопируйте этот токен.

## Шаги настройки

1. Установите и включите плагин в SiYuan.
2. Нажмите на иконку `Настройки` в верхней панели или в списке плагинов.
3. Найдите раздел настроек плагина `SiYuan Share`.
4. Заполните три указанных выше поля:
   - Адрес сервера
   - API Token
   - Токен ядра SiYuan
5. Нажмите кнопку `Проверить соединение` (Test Connection) для проверки настроек.
6. Нажмите `Сохранить`.

## Функция проверки соединения

После настройки **настоятельно рекомендуется** нажать кнопку `Проверить соединение`:

### Что проверяется:

1. **Проверка API Token бэкенда**:
   - Вызывается эндпоинт `/api/health` (требует авторизации).
   - **Проверка валидности**: Если токен неверный, вернется ошибка 401.
   - Проверяется доступность сервера по сети.
   - В случае успеха: ✅ Бэкенд API в норме (Пользователь: xxx)

2. **Проверка API токена ядра SiYuan**:
   - Вызывается эндпоинт `/api/system/version` (требует авторизации).
   - **Проверка валидности**: Если токен неверный, вернется ошибка 401.
   - Проверяется доступ плагина к внутренним данным SiYuan.
   - В случае успеха: ✅ Ядро SiYuan API в норме (Версия: xxx)

## Инструкция по использованию

После настройки вы можете:

1. **Публиковать через меню дерева документов**:
   - Нажмите правой кнопкой на документ в дереве.
   - Выберите `Опубликовать этот документ` (Share this document).

2. **Публиковать через кнопку в заголовке**:
   - Откройте нужный документ.
   - Нажмите на иконку публикации в верхней панели.

3. **Опции публикации**:
   - Установка пароля для доступа.
   - Срок действия ссылки (в днях).
   - Публичный или приватный доступ.

## Процесс вызова API

1. **Экспорт контента**:
   - Используется `Токен ядра SiYuan` для вызова `/api/export/exportMdContent`.
   - Получение Markdown-содержимого документа.

2. **Создание публикации**:
   - Используется `API Token` бэкенда для вызова `/api/share/create`.
   - Передача содержимого, заголовка, пароля и других данных.
   - Бэкенд возвращает ID публикации и готовую ссылку.

3. **Локальное сохранение**:
   - Плагин сохраняет запись о публикации в локальное хранилище для последующего управления.

## Важные моменты

1. **Безопасность токенов**:
   - Все токены хранятся только локально.
   - Они не передаются в облако или сторонним лицам.
   - Рекомендуется периодически обновлять токены.

2. **Требования к сети**:
   - Должен быть доступ к адресу вашего бэкенд-сервиса.
   - Для экспорта должен быть доступен локальный API SiYuan.

## Устранение неполадок

### Ошибка экспорта документа
- Проверьте правильность токена ядра SiYuan.
- Убедитесь, что ID документа существует.

### Ошибка создания публикации
- Проверьте доступность адреса сервера.
- Убедитесь в валидности API Token бэкенда.
- Проверьте, запущен ли бэкенд-сервис.

## История обновлений

### 2025-11-07
- ✅ Добавлено поле для токена ядра SiYuan.
- ✅ Реализована логика экспорта через официальный API.
- ✅ Улучшена проверка конфигурации и сообщения об ошибках.
- ✅ Добавлена функция проверки соединения (Test Connection).
