# Реализация парсера Kramdown

## Обзор

В данном обновлении метод экспорта документов был изменен с `/api/export/exportMdContent` на `/api/block/getBlockKramdown`. Исходный код Kramdown преобразуется в Markdown на стороне фронтенда с помощью JavaScript-парсера перед отправкой на бэкенд.

## Основные изменения

### 1. Новые файлы

#### `src/utils/kramdown-parser.ts`
Основной модуль конвертера Kramdown → Markdown.

**Основные функции:**
- `parseKramdownToMarkdown(kramdown, options?)`: главная функция парсинга.
- `cleanIALAttributes()`: очистка блоков атрибутов IAL `{: id="..." ...}`.
- `convertBlockReferences()`: преобразование ссылок на блоки `((id))` → `[ссылка]` или `((id "текст"))` → `[текст]`.
- `cleanEmbedQueries()`: удаление встроенных запросов `{{SELECT ...}}`.
- `cleanBasicSyntax()`: очистка YAML front matter и строк метаданных.
- `resolveBlockRef()`: зарезервированный интерфейс для будущего получения контента блоков и развертывания ссылок.

#### `src/utils/kramdown-parser.test.ts`
Файл с тестовыми случаями для отладки. Охватывает:
- Очистку атрибутов IAL.
- Конвертацию ссылок на блоки (с текстом и без).
- Удаление встроенных запросов.
- Очистку YAML front matter.
- Сложные вложенные структуры.
- Граничные случаи (пустой ввод, только атрибуты).

### 2. Измененные файлы

#### `src/services/share-service.ts`
- **Изменение эндпоинта API**: `/api/export/exportMdContent` → `/api/block/getBlockKramdown`.
- **Параметры запроса**: добавлен параметр `mode: "md"` (стандартный режим Markdown).
- **Парсинг ответа**: получение данных из `data.kramdown` вместо `data.content`.
- **Интеграция парсера**: вызов `parseKramdownToMarkdown()` для конвертации контента.
- **Обработка ошибок**: разграничение ошибок вызова API, ошибок ответа и ошибок парсинга с уведомлением пользователя.
- **Удаление кода**: метод `cleanMarkdownContent()` удален (функционал перенесен в парсер).

## Технические подробности

### Особенности формата Kramdown в SiYuan

1. **IAL (Inline Attribute List)**
   Бывают двух видов: блочные (на отдельной строке) и строчные (внутри элемента). Оба вида успешно очищаются парсером.
   
2. **Ссылки на блоки**
   Преобразуются в текстовые ссылки или якорные ссылки (в зависимости от настроек).

3. **Встроенные запросы**
   В текущей реализации удаляются для предотвращения утечки технических данных.

## Стратегия обработки ошибок

Парсер реализует многоуровневую проверку:
1. Ошибка сетевого запроса API.
2. Проверка HTTP-статуса ответа.
3. Проверка внутреннего кода ответа SiYuan (`code !== 0`).
4. Проверка результата парсинга (пустой результат или исключение).

## Планы по развитию

### 1. Развертывание ссылок на блоки (краткосрочно)
Реализация асинхронного получения контента ссылаемых блоков для вставки их текста прямо в документ.

### 2. Выполнение встроенных запросов (среднесрочно)
Замена `{{SELECT ...}}` на результат выполнения SQL-запроса в ядре SiYuan.

### 3. Обработка ресурсов (долгосрочно)
Автоматическое копирование изображений и вложений в облачное хранилище или конвертация в Base64.

---

**Дата обновления**: 08.11.2025  
**Версия**: v1.0.0  
**Статус**: ✅ Базовая реализация завершена
