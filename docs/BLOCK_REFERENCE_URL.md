# Реализация ссылок на блоки через URL

## Способ реализации

При клике на ссылку на блок открывается **новая страница с уникальным URL**, отображающая контент ссылаемого блока, вместо якорного перехода внутри той же страницы.

## Поток данных

### 1. Исходный документ

```markdown
# заголовок

> описание

((20251108094416-arwps1t 'привет'))
```

### 2. Обработка на фронтенде

Плагин извлекает ссылки и получает их контент:
```typescript
references: [
  {
    blockId: "20251108094416-arwps1t",
    content: "мир",
    displayText: "привет",
    refCount: 1
  }
]
```

### 3. Создание публикации на бэкенде

#### Основная публикация
```
ID: a93a17caa294becc865bcdc054706fb2
DocID: 20251107091012-5z3fb33
Content: "# заголовок\n\n> описание\n\n((20251108094416-arwps1t 'привет'))"
References: '[{"blockId":"20251108094416-arwps1t","content":"мир","refCount":1}]'
```

#### Создание дочерних публикаций для каждой ссылки
```
ID: b1234567890abcdef (генерируется автоматически)
DocID: 20251108094416-arwps1t (используется blockId)
DocTitle: "Блок: 20251108094416-arwps1t"
Content: "мир"
ParentShareID: a93a17caa294becc865bcdc054706fb2
ExpireAt: (наследуется от основной)
RequirePassword: (наследуется от основной)
PasswordHash: (наследуется от основной)
```

### 4. Замена ссылок при просмотре

Когда пользователь запрашивает основную публикацию `GET /api/s/a93a17caa294becc865bcdc054706fb2`:

1. Поиск соответствующей записи дочерней публикации:
   ```sql
   SELECT * FROM shares 
   WHERE user_id = 'xxx' 
     AND doc_id = '20251108094416-arwps1t' 
   ORDER BY created_at DESC 
   LIMIT 1
   ```

2. Замена синтаксиса ссылки на URL публикации:
   ```markdown
   Было: ((20251108094416-arwps1t 'привет'))
   Стало: [привет](https://share.your-domain.com/s/b1234567890abcdef)
   ```

3. Возврат обработанного контента.

### 5. Взаимодействие с пользователем

- Пользователь открывает: `https://share.your-domain.com/s/a93a17caa294becc865bcdc054706fb2`
- Видит текст, где слово «привет» является ссылкой.
- Кликает по ссылке.
- **Открывается новая страница**: `https://share.your-domain.com/s/b1234567890abcdef`
- Отображается контент блока: «мир».

## Структура базы данных

### Новые поля в таблице `shares`

```sql
ALTER TABLE shares ADD COLUMN parent_share_id VARCHAR(64);
CREATE INDEX idx_parent_share_id ON shares(parent_share_id);
```

- `parent_share_id`: ID родительской публикации.
- Для основного документа: `parent_share_id = ""`
- Для ссылаемого блока: `parent_share_id = "ID_основной_публикации"`

## Преимущества

1. **Независимый доступ**: каждый блок имеет свою ссылку и может быть открыт отдельно.
2. **Наследование прав**: блоки наследуют пароль и срок действия основного документа.
3. **Стабильность ссылок**: ссылки на блоки не ломаются при обновлении основного документа.
4. **Удобство обмена**: можно делиться ссылкой на конкретный фрагмент текста.

---

**Дата реализации**: 08.11.2025  
**Версия**: v2.0.0  
**Статус**: ✅ Реализовано (через независимые URL)
