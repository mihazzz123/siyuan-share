# Инструкция по загрузке ресурсов в S3

## Обзор

Плагин SiYuan Share теперь поддерживает автоматическую загрузку изображений и вложений из документов в S3-совместимые объектные хранилища. При публикации локальные пути к ресурсам заменяются на S3-ссылки, что повышает скорость доступа и надежность отображения контента.

## Возможности

### 1. Настройка S3
- **Полная поддержка S3**: эндпоинт, регион, бакет, ключи доступа.
- **Пользовательский домен CDN**: поддержка использования ускоряющих доменов CDN для доступа к ресурсам.
- **Настройка префикса пути**: удобная организация и управление объектами в хранилище.
- **Безопасное локальное хранение**: все настройки сохраняются только на вашем устройстве и не передаются на сервер публикации.

### 2. Обработка ресурсов
- **Автоматическое обнаружение**: извлечение ссылок на изображения и вложения из Markdown-контента.
- **Умное удаление дубликатов**: использование хеш-суммы файлов для предотвращения повторной загрузки одних и тех же ресурсов.
- **Пакетная загрузка**: поддержка одновременной загрузки нескольких файлов.
- **Замена ссылок**: автоматическая замена локальных путей на URL-адреса S3.

### 3. Управление записями о ресурсах
- **Локальное сопоставление**: сохранение связи между документами и ресурсами в S3.
- **Персистентность в бэкенде**: передача информации о ресурсах на бэкенд для долгосрочного хранения.
- **Инкрементальное обновление**: поддержка обработки ресурсов при обновлении документов.

## Инструкция по настройке

### Предварительные условия
1. S3-совместимое объектное хранилище (AWS S3, Cloudflare R2, MinIO, Yandex Object Storage и др.).
2. Созданный бакет (Bucket) с настроенными правами на публичное чтение.
3. Ключи доступа (Access Key ID и Secret Access Key).

### Шаги настройки

1. Откройте настройки плагина.
2. Перейдите на вкладку "☁️ S3 Storage".
3. Заполните следующие поля:

| Параметр | Описание | Пример |
|--------|------|------|
| Включить S3 | Ресурсы будут загружаться в S3 только при включении этой опции | Отмечено |
| Эндпоинт S3 | URL-адрес сервиса S3 | `s3.amazonaws.com` или `s3.storage.yandexcloud.net` |
| Регион (Region) | Регион расположения бакета | `us-east-1` или `ru-central1` |
| Бакет (Bucket) | Имя бакета для хранения ресурсов | `my-siyuan-share` |
| Access Key ID | ID ключа доступа S3 | `AKI***` |
| Secret Access Key | Секретный ключ доступа S3 | `***` |
| Пользовательский домен CDN | (Опционально) Домен ускорения CDN | `https://cdn.example.com` |
| Префикс пути | (Опционально) Префикс пути для объектов | `siyuan-share` |

4. Сохраните конфигурацию.

## Процесс использования

### Автоматическая загрузка при публикации

1. После настройки S3 создайте публикацию обычным способом.
2. Плагин автоматически:
   - Просканирует документ и извлечет все локальные ссылки на ресурсы.
   - Получит файлы ресурсов из SiYuan.
   - Вычислит хеш-сумму файлов для проверки на дубликаты.
   - Загрузит новые ресурсы в S3.
   - Заменит ссылки в Markdown на URL-адреса S3.
   - Сохранит записи о сопоставлении локально.
   - Передаст информацию о ресурсах в бэкенд.

### Обработка путей ресурсов

Плагин автоматически обрабатывает следующие форматы ссылок:

```markdown
# Синтаксис изображений Markdown
![Описание](assets/image.png)

# Синтаксис ссылок Markdown
[Скачать файл](assets/document.pdf)

# HTML тег img
<img src="assets/photo.jpg" />
```

После загрузки они будут заменены на:

```markdown
![Описание](https://your-bucket.s3.amazonaws.com/siyuan-share/1699999999999-abc123def456.png)
```

## Техническая реализация

### Именование файлов
- Формат: `{префиксPath}/{timestamp}-{hash}.{ext}`
- Пример: `siyuan-share/1699999999999-abc123def456.png`
- Преимущества: метка времени обеспечивает уникальность, хеш используется для дедупликации.

### Механизм дедупликации
1. Вычисляется SHA-256 хеш файла (берутся первые 16 символов).
2. Выполняется поиск файла с таким же хешем в локальных записях.
3. Если файл найден, используется существующий S3 URL, загрузка пропускается.

### Структура данных

#### AssetUploadRecord (Запись о загрузке ресурса)
```typescript
{
  localPath: string;      // Локальный путь
  s3Key: string;          // Ключ объекта в S3
  s3Url: string;          // URL доступа S3
  contentType: string;    // MIME-тип
  size: number;           // Размер файла
  hash: string;           // Хеш файла
  uploadedAt: number;     // Метка времени загрузки
}
```

#### DocAssetMapping (Сопоставление ресурсов документа)
```typescript
{
  docId: string;          // ID документа
  shareId: string;        // ID публикации
  assets: AssetUploadRecord[];
  createdAt: number;
  updatedAt: number;
}
```

### Локальное хранение
- Ключ хранилища: `asset-mappings`
- Формат: массив JSON.
- Персистентность: автоматическое сохранение в папку данных плагина.

### Интеграция с бэкендом
Запрос на создание публикации содержит поле `assets`, которое бэкенд может использовать для:
1. Сохранения информации о сопоставлении ресурсов.
2. Кэширования и управления контентом публикации.
3. Сбора статистики использования ресурсов.

## Важные замечания

### Безопасность
1. **Защита ключей доступа**: Access Key и Secret Key хранятся только локально и не передаются на сервер публикации.
2. **Права доступа к бакету**: Рекомендуется устанавливать "Публичное чтение, приватная запись".
3. **CDN домен**: При использовании CDN убедитесь в правильной настройке политик CORS и кэширования.

### Затраты
1. **Стоимость хранения**: зависит от размера и количества загруженных файлов.
2. **Стоимость трафика**: каждый просмотр публикации генерирует исходящий трафик S3.
3. **Стоимость запросов**: загрузка и доступ генерируют API-запросы.
4. **Стоимость CDN**: использование CDN может повлечь дополнительные расходы.

Рекомендации:
- Периодически удаляйте ресурсы устаревших публикаций.
- Используйте CDN для снижения затрат на прямой трафик S3.
- Настройте правила жизненного цикла объектов для автоматического удаления старых файлов.

### Совместимость
1. **S3-совместимость**: поддержка AWS S3, Cloudflare R2, MinIO и др.
2. **Версия подписи**: реализован алгоритм AWS Signature V4, совместимый со всеми современными S3-сервисами.
3. **Типы ресурсов**: поддержка изображений, видео, аудио, документов и других типов файлов.

### Устранение неполадок
1. **Ошибка загрузки**: если загрузка ресурса не удалась, публикация продолжится с оригинальным контентом (процесс не прерывается).
2. **Частичная неудача**: при пакетной загрузке ошибки для отдельных файлов будут отображены в логах, а для успешных файлов ссылки будут заменены.
3. **Тайм-аут сети**: загрузка больших файлов может прерваться по таймауту; рекомендуется сжимать изображения перед публикацией.

## Планы на будущее

- [x] Поддержка AWS Signature V4 ✅
- [ ] Поддержка докачки файлов
- [ ] Автоматическое сжатие изображений
- [ ] Пакетное удаление ресурсов S3 из плагина
- [ ] Статистика использования ресурсов
- [ ] Поддержка нескольких конфигураций S3
- [ ] Поддержка других протоколов (WebDAV, FTP и т.д.)

## Часто задаваемые вопросы

### Q: Ошибка загрузки с упоминанием CORS?
A: Необходимо настроить политику CORS в бакете S3, разрешив запросы из приложения SiYuan.

### Q: Как удалить загруженные ресурсы?
A: В текущей версии это нужно делать вручную через панель управления S3. В будущем появится возможность удаления через плагин.

### Q: Какие сервисы поддерживаются?
A: Все S3-совместимые, включая:
- AWS S3
- Cloudflare R2
- Yandex Object Storage
- MinIO (self-hosted)
- Google Cloud Storage (в режиме S3)
- И многие другие.

## Техническая поддержка

Если у вас возникли вопросы или предложения:
1. Создайте Issue на GitHub.
2. Напишите в сообществе SiYuan.
3. Проверьте логи плагина (консоль разработчика).
