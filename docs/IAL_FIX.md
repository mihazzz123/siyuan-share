# Исправление очистки атрибутов IAL

## Описание проблемы

При использовании парсера Kramdown было обнаружено, что некоторые блоки сохраняют информацию об атрибутах IAL (Inline Attribute List), например:

```markdown
1. {: id="20251106140708-noc3gik" updated="20251106140708" fold="1" heading-fold="1"}Содержимое пункта
* {: id="20201225220955-2nn1mns"}Новый блокнот
`код`{: id="xxx"}
```

Эти атрибуты IAL должны быть удалены при конвертации в стандартный Markdown.

## Первопричина

Исходная функция `cleanIALAttributes()` обрабатывала только **IAL на отдельных строках**:

```markdown
Текст параграфа
{: id="20210101-abc1234" style="color:red"}
```

Однако в формате Kramdown, используемом в SiYuan, IAL также может быть **строчным (inline)**:

```markdown
* {: id="xxx"}Элемент списка          ← В начале элемента
1. {: id="xxx"}Нумерованный список    ← В начале нумерованного списка
`код`{: id="xxx"}                    ← После строчного элемента
Текст{: style="color:red"}           ← В середине текста
```

Старое регулярное выражение `/^[ \t]*\{:.*?\}\s*$/gm` соответствовало только случаям, когда вся строка целиком является IAL, и не могло обработать строчные атрибуты.

## Решение

Функция `cleanIALAttributes()` была изменена для последовательной обработки всех типов IAL:

### 1. Очистка IAL в начале элементов списка

```typescript
// "* {: id=\"xxx\"}текст" → "* текст"
result = result.replace(/^(\s*[-*+]\s+)\{:.*?\}/gm, '$1');
```

### 2. Очистка IAL в начале нумерованных списков

```typescript
// "1. {: id=\"xxx\"}текст" → "1. текст"
result = result.replace(/^(\s*\d+\.\s+)\{:.*?\}/gm, '$1');
```

### 3. Очистка всех строчных IAL

```typescript
// "текст{: attr=\"value\"}текст" → "тексттекст"
result = result.replace(/\{:\s*[^}]*?\}/g, '');
```

### 4. Очистка IAL на отдельных строках

```typescript
// Случай, когда вся строка является IAL
result = result.replace(/^[ \t]*\{:.*?\}\s*$/gm, '');
```

### 5. Очистка пустых строк

```typescript
// Очистка строк, содержащих только пробелы (могут появиться после шага 4)
result = result.replace(/^[ \t]+$/gm, '');

// Очистка лишних пустых строк (оставляем максимум две подряд)
result = result.replace(/\n{3,}/g, '\n\n');
```

## Тестирование и верификация

Был создан специальный тестовый скрипт `test-ial.js`, включающий следующие случаи:

1. ✅ IAL в начале элементов списка.
2. ✅ IAL в нумерованных списках.
3. ✅ IAL после строчного кода.
4. ✅ IAL на отдельной строке.
5. ✅ Смешанные типы (несколько IAL одновременно).

Все тесты пройдены успешно.

## Область влияния

### Измененные файлы

1. **src/utils/kramdown-parser.ts**
   - Изменена реализация функции `cleanIALAttributes()`.
   - Добавлены подробные комментарии.

2. **src/utils/kramdown-parser.test.ts**
   - Добавлены тесты для строчных IAL.
   - Добавлены тесты для смешанных типов.

3. **docs/KRAMDOWN_IMPLEMENTATION.md**
   - Обновлено описание формата IAL.
   - Добавлены примеры строчных IAL.

4. **test-ial.js** (новый)
   - Независимый скрипт для быстрой проверки.

### Обратная совместимость

✅ Полная совместимость, не влияет на существующий функционал:
- Сохранена логика очистки IAL на отдельных строках.
- Новая логика очистки строчных IAL не повреждает другой контент.
- Все старые тесты по-прежнему проходят.

## Примеры использования

### До исправления

```markdown
Вход:
1. {: id="20251106140708-noc3gik" updated="20251106140708"}Пункт
   {: id="sub-item"}

Выход:
1. {: id="20251106140708-noc3gik" updated="20251106140708"}Пункт  ← ❌ IAL не очищен
```

### После исправления

```markdown
Вход:
1. {: id="20251106140708-noc3gik" updated="20251106140708"}Пункт
   {: id="sub-item"}

Выход:
1. Пункт  ← ✅ IAL успешно очищен
```

---

**Дата исправления**: 08.11.2025  
**Версия**: v1.0.1  
**Статус**: ✅ Исправлено и протестировано
