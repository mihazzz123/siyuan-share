# SiYuan - Плагин публикации (Share Plugin)

> Плагин для SiYuan, который позволяет делиться заметками, делая их доступными через интернет.
> Этот плагин необходимо установить внутри приложения SiYuan.

# Справочник по API плагина SiYuan и бэкенда

> Цель: Собрать воедино информацию об API, которая используется при разработке плагина «SiYuan Share». Охватывает HTTP API бэкенда и API фронтенд-плагина (UI/события/хранилище/сеть). Данный документ является справочником для разработчиков и не содержит кода реализации.

Последнее обновление: 2025-11-07

---

## 0. Обзор и авторизация

- **HTTP API бэкенда (ядро SiYuan)**
  - В основном используется POST (за исключением загрузки файлов и т.д.).
  - Авторизация: `Authorization: Token <token>` (Токен ядра), возвращает стандартную структуру: `{ code, msg, data }`.
  - Успешный ответ: `code === 0`.
- **API фронтенд-плагина**
  - Основано на официальной библиотеке типов (petal) и примере плагина (plugin-sample).
  - Основные возможности: вставки в UI, команды/горячие клавиши, события, доступ к редактору, хранилище, иконки, окна/панели.

---

## 1. HTTP API бэкенда (по категориям)

> Примечание: Пути взяты из официальной документации API SiYuan. Параметры сокращены до наиболее часто используемых при разработке.

### 1.1 Блокноты / Дерево файлов (filetree)

| Эндпоинт | Функция | Ключевые параметры | Примечание |
|------|------|----------|------|
| /api/notebook/lsNotebooks | Список блокнотов | - | Выбор области публикации |
| /api/notebook/openNotebook | Открыть блокнот | notebook | - |
| /api/notebook/closeNotebook | Закрыть блокнот | notebook | - |
| /api/filetree/createDocWithMd | Создать документ из Markdown | notebook, path, markdown | - |
| /api/filetree/renameDoc | Переименовать по пути | notebook, path, title | - |
| /api/filetree/renameDocByID | Переименовать по ID | id, title | - |
| /api/filetree/removeDoc | Удалить по пути | notebook, path | - |
| /api/filetree/removeDocByID | Удалить по ID | id | - |
| /api/filetree/moveDocs | Переместить документы (путь) | fromPaths[], toNotebook, toPath | - |
| /api/filetree/moveDocsByID | Переместить документы (ID) | fromIDs[], toID | - |
| /api/filetree/getHPathByID | Получить читаемый путь (HPath) | id | Генерация slug/относительных ссылок |
| /api/filetree/getIDsByHPath | Получить ID по HPath | notebook, path | - |

### 1.2 Блоки (block) и структура

| Эндпоинт | Функция | Ключевые параметры | Примечание |
|------|------|----------|------|
| /api/block/insertBlock | Вставить блок | data, dataType, previousID/parentID | dataType: markdown/dom |
| /api/block/prependBlock | Вставить блок в начало | data, dataType, id | - |
| /api/block/appendBlock | Вставить блок в конец | data, dataType, id | - |
| /api/block/updateBlock | Обновить содержимое блока | id, data, dataType | - |
| /api/block/deleteBlock | Удалить блок | id | - |
| /api/block/moveBlock | Переместить блок | id, previousID/parentID | - |
| /api/block/getChildBlocks | Список дочерних блоков | id | Построение оглавления (TOC) |
| /api/block/getBlockKramdown | Получить Kramdown | id | Исходная структура разметки (с ссылками) |
| /api/block/transferBlockRef | Перенести ссылки | fromID, toID, refIDs[] | Обновление обратных ссылок |

### 1.3 Атрибуты (attr) и запросы

| Эндпоинт | Функция | Ключевые параметры | Примечание |
|------|------|----------|------|
| /api/attr/getBlockAttrs | Получить атрибуты блока | id | Содержит метку времени updated |
| /api/attr/setBlockAttrs | Установить атрибуты блока | id, attrs | - |
| /api/query/sql | SQL-запрос | stmt | Инкрементально: `SELECT id, updated FROM blocks ...` |

### 1.4 Шаблоны/Рендеринг (template)

| Эндпоинт | Функция | Ключевые параметры | Примечание |
|------|------|----------|------|
| /api/template/render | Рендеринг шаблона | id/path или template | Можно использовать перед экспортом |
| /api/template/renderSprig | Рендеринг шаблона Sprig | template, data | Опционально |

### 1.5 Файлы (file) и ресурсы

| Эндпоинт | Функция | Ключевые параметры | Примечание |
|------|------|----------|------|
| /api/file/getFile | Читать файл | path | Получение .sy, ресурсов и т.д. |
| /api/file/putFile | Записать файл/директорию | multipart | Рекомендуется через API, а не прямое IO |
| /api/file/readDir | Список файлов в директории | path | Перечисление ресурсов |
| /api/file/removeFile | Удалить файл | path | - |
| /api/file/renameFile | Переименовать файл | path, newPath | - |

### 1.6 Экспорт/Конвертация (export/convert)

| Эндпоинт | Функция | Ключевые параметры | Примечание |
|------|------|----------|------|
| /api/export/exportMdContent | Экспорт документа в Markdown | id | Возвращает hPath + content |
| /api/export/exportResources | Упаковать файлы/директории | paths[], name | Возвращает путь к zip-архиву |
| /api/convert/pandoc | Вызов Pandoc | dir, args | EPUB/Docx→MD и т.д. (требуется окружение) |

> Пояснение: Наличие единого эндпоинта для экспорта в PDF/Word/Image уточняется. Сейчас обычно используется Markdown/ресурсы как база, при необходимости дополняется Pandoc или фронтенд-рендерингом.

### 1.7 Уведомления/Сеть/Система

| Эндпоинт | Функция | Ключевые параметры | Примечание |
|------|------|----------|------|
| /api/notification/pushMsg | Уведомление в интерфейсе | msg, timeout | Обратная связь о процессе |
| /api/notification/pushErrMsg | Ошибка в интерфейсе | msg, timeout | Обратная связь об ошибках |
| /api/network/forwardProxy | Проксирование внешнего запроса | url, method, headers, payload | Решение проблем CORS и скрытие ключей |
| /api/system/version | Версия ядра | - | Проверка совместимости версий |
| /api/system/currentTime | Текущее время | - | Построение метаданных |

---

## 2. API фронтенд-плагина (UI/Команды/События/Редактор/Хранилище/Константы)

> Типы и имена основаны на официальных библиотеках (petal/types) и примерах плагинов. Детали могут зависеть от версии.

### 2.1 Вставки в UI и окна/панели

- `addTopBar` / `addStatusBar`: Добавление кнопок в верхнюю панель или строку состояния.
- `addDock` / `addTab` / `addFloatLayer`: Добавление панелей, вкладок или плавающих слоев (для отображения панели публикации/прогресса).
- `openWindow({doc})` / `openTab({doc|custom})`: Открытие документа или пользовательского представления.
- `Dialog`: `new Dialog(options)` — создание диалогового окна (конфигурация/подтверждение).

### 2.2 Меню и команды/горячие клавиши

- `Menu`: `new Menu()` — создание меню, `addItem({label, icon, click, ...})` — добавление пунктов.
- `addCommand({ name, langId, hotkey, callback })`: Регистрация команды и горячих клавиш.
- Типичное использование: Добавление пункта «Поделиться документом/блоком» в контекстное меню дерева файлов или редактора.

### 2.3 Доступ к редактору (Protyle)

- `getAllEditor()`: Получение списка активных экземпляров редактора (Protyle).
- Связанное с Protyle: `insert()`, `transaction()`, `focus()` и т.д.
- Назначение: Определение ID текущего документа/блока, получение контекстной информации (основной процесс экспорта обычно идет через HTTP API).

### 2.4 Хранилище и конфигурация

- Личные данные плагина: `plugin.saveData(key, value)`, `loadData(key)`, `removeData(key)`.
  - Используется для сохранения настроек пользователя, стратегий публикации, сторонних ключей (старайтесь не сохранять токен ядра).
- Глобальное LocalStorage: Используйте официальные ключи констант (например, `LOCAL_*`) только при необходимости совместного использования, чтобы избежать конфликтов.

### 2.5 Иконки и ресурсы

- `addIcons(svgSymbols)`: Регистрация пользовательских SVG-символов для использования в кнопках и меню.

### 2.6 Окружение и шина событий

- `getFrontend()` / `getBackend()`: Определение платформы запуска (десктоп/мобильное/веб и т.д.).
- `eventBus.on(name, callback)` / `off(name, callback)`: Подписка/отписка от событий (список имен ниже).

### 2.7 Полезные константы (выборочно)

- Константы для экспорта, диалогов, клавиш, тем и т.д. из `constants.ts`.
- Темы подсветки кода: `SIYUAN_CONFIG_APPEARANCE_DARK_CODE` / `...LIGHT_CODE` (массивы).
- Локальная разметка и Dock: `LOCAL_LAYOUTS` / `LOCAL_PLUGIN_DOCKS`.
- Ключи локального кэша экспорта: `LOCAL_EXPORTPDF` / `LOCAL_EXPORTWORD` / `LOCAL_EXPORTIMG` (доступность зависит от версии).

---

## 3. События фронтенда (примеры и назначение)

> События не полностью документированы, информация взята из типов и примеров кода.

| Имя события (пример) | Назначение |
|----------------|------|
| ws-main | Сообщения основного канала WebSocket (глобально) |
| click-blockicon | Клик по иконке блока (можно расширить для «Поделиться блоком») |
| loaded-protyle-static / loaded-protyle-dynamic | Редактор загружен (инициализация) |
| switch-protyle | Переключение контекста редактора (обновление текущего ID документа) |
| open-menu-doctree | Построение меню дерева файлов (вставка пункта публикации) |
| open-menu-blockref / open-menu-tag / open-menu-link | Точки построения соответствующих меню |
| paste | Событие вставки (проверка на чувствительные данные) |
| opened-notebook / closed-notebook | Открытие/закрытие блокнота (обновление области видимости) |
| DIALOG_* (например, DIALOG_COMMANDPANEL) | Идентификаторы типов диалогов (логика взаимодействия) |

---

## 4. Сеть и CORS

- Прямой `fetch`: Доступен в десктопной и браузерной версиях; осторожно обращайтесь со сторонними ключами (не вшивайте их в код).
- `forwardProxy` (`/api/network/forwardProxy`): Проксирование внешних запросов через ядро для скрытия источника и обхода CORS.
- CORS: Локальный 127.0.0.1 обычно не имеет строгих ограничений; при развертывании следуйте политикам платформы.

---

## 5. Стратегия хранения

- Приоритет хранилища плагина: Изолированное пространство имен во избежание конфликтов.
- Чувствительная информация: Не сохраняйте токен ядра; ключи сторонних платформ можно шифровать локально или запрашивать по необходимости.
- Временный кэш: Используйте переменные в памяти или на уровне сессии для хранения временных состояний.

---

## 6. Экспорт и инкрементальность (связь с API)

- Используйте `/api/export/exportMdContent` для экспорта Markdown (включая hPath) как основы контента.
- Используйте `/api/file/getFile` / `/api/file/readDir` / `/api/export/exportResources` для копирования изображений, вложений и других статических ресурсов.
- Используйте `updated` из `/api/attr/getBlockAttrs` или `blocks.updated` из `/api/query/sql` для определения изменений (инкрементальность).
- Генерация `manifest.json` (запись id каждого документа, updated, hash, путь) для дифференциальной загрузки и попадания в кэш.

---

## 7. Ссылки на справочные материалы

- Примеры плагинов (RU): https://github.com/siyuan-note/plugin-sample/blob/main/README_zh_CN.md (на кит., используйте переводчик)
- Примеры плагинов (EN): https://github.com/siyuan-note/plugin-sample/blob/master/README.md
- Пример plugin.json: https://github.com/siyuan-note/plugin-sample/blob/master/plugin.json
- HTTP API бэкенда (RU/CN): https://github.com/siyuan-note/siyuan/blob/master/API_zh_CN.md
- HTTP API бэкенда (EN): https://github.com/siyuan-note/siyuan/blob/master/API.md
- Типы фронтенда (вход): https://github.com/siyuan-note/petal/blob/master/README.md
- Типы констант/событий:
  - constants.ts: https://github.com/siyuan-note/petal/blob/master/types/constants.ts
  - events.d.ts: https://github.com/siyuan-note/petal/blob/master/types/events.d.ts
  - index.d.ts: https://github.com/siyuan-note/petal/blob/master/types/index.d.ts

---

## 8. Список для проверки (связано с API)

1. Существует ли стабильный официальный эндпоинт для прямого экспорта в PDF/Word/Image (пока рекомендуется Markdown + конвертация).
2. Полный список шины событий и стабильность версий (имена могут меняться).
3. Совместимость и возможность активации констант из `constants.ts` (экспорт/диалоги).
4. Рекомендуемый способ получения CSS темы (через упаковку ресурсов экспорта).
5. Базируется ли цепочка OceanPress и экспорта полностью на API бэкенда (без прямого чтения каталога данных).
6. Актуальные требования к полям i18n в `plugin.json`.

---

## 9. Рекомендации по реализации (для «Share Plugin»)

- Используйте API бэкенда для получения контента и ресурсов, избегайте прямого чтения папки данных.
- Подтверждение перед публикацией: просмотр списка + фильтрация чувствительных слов/атрибутов.
- Не сохраняйте токен ядра во фронтенд-скриптах; для внешних платформ используйте PAT/AK/SK пользователя.
- Инкрементальная сборка: использование `updated`/hash и `manifest.json` значительно сокращает время повторной публикации.
- CDN/Кэширование: генерация имен файлов с хешем; короткий кэш для `index.html` + query-параметр версии для принудительного обновления.
